var util = require('util'),
	EE = require('events').EventEmitter,
	net = require('net');

var ecoBotServer = function(port) {

	var self = this,
		buffer = '',
        parsedData = '';

	function init(ecoPort) {
		
		var server = net.createServer(function(connection) {
			connection.on('data', function(data) {
				emitNewMessage(data);
			});

            connection.on('error', function(e) {
                buffer = '';
            });
		});

		server.listen(ecoPort);


	};

	function emitNewMessage(data) {
		buffer += data.toString();
		var boundary = buffer.indexOf('|');
		while(boundary !== -1) {
			var input = buffer.substr(0, boundary);
			buffer = buffer.substr(boundary + 1);

            try {
                parsedData = JSON.parse(input);
                self.emit('sensor', parsedData);
                boundary = buffer.indexOf('|');
            } catch(e) {
                console.log(e);
                buffer = '';
            }
		}
	};

	init(port);
};

util.inherits(ecoBotServer, EE);
module.exports = ecoBotServer;